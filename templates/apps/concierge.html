{% extends "base.html" %}
{% block title %}Concierge Tracker — GoLive Staffing{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Concierge Tracker</h1>
<p class="text-gray-700 mb-6">
  Upload your employee roster and keep a running list of Active employees hired from October 1, 2025 forward.
  Use the table to record concierge calls, assign recruiters, and track which hires have been concierged.
</p>

{% if notice %}
  <div class="mb-4 rounded border border-green-200 bg-green-50 px-4 py-3 text-green-800">{{ notice }}</div>
{% endif %}
{% if error %}
  <div class="mb-4 rounded border border-red-200 bg-red-50 px-4 py-3 text-red-800">{{ error }}</div>
{% endif %}

<section class="bg-white shadow-sm border rounded-2xl p-5 mb-6">
  <h2 class="text-lg font-semibold mb-3">Upload roster</h2>
  <form action="/concierge/upload" method="post" enctype="multipart/form-data" class="space-y-3 md:flex md:items-center md:space-y-0 md:space-x-4">
    <div class="flex-1">
      <input type="file" name="file" accept=".xlsx,.csv" required class="w-full text-sm" />
      <p class="text-xs text-gray-500 mt-1">Required columns: Employee ID, Status, First Name, Last Name, Start Date, Rehire Date, Concierge Date, Mobile, Language.</p>
      <p class="text-xs text-gray-500">Only Active employees with a Start Date or Rehire Date on/after 2025-10-01 will be added. Existing Employee IDs are kept.</p>
    </div>
    <button type="submit" class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">Upload</button>
  </form>
</section>

<section class="bg-white shadow-sm border rounded-2xl p-5 mb-6">
  <div class="flex flex-wrap items-center gap-4 justify-between">
    <div>
      <h2 class="text-lg font-semibold">Concierge list</h2>
      <p class="text-sm text-gray-600">Total employees: {{ summary.total }} · Concierged: {{ summary.concierged }}</p>
    </div>
    <form action="/concierge" method="get" class="flex flex-wrap items-center gap-2 text-sm">
      <input type="hidden" name="sort" value="{{ sort }}" />
      <label for="concierged" class="text-gray-700">Filter:</label>
      <select id="concierged" name="concierged" class="border rounded-md px-2 py-1">
        <option value="all" {% if concierged_filter == 'all' %}selected{% endif %}>All</option>
        <option value="yes" {% if concierged_filter == 'yes' %}selected{% endif %}>Concierged</option>
        <option value="no" {% if concierged_filter == 'no' %}selected{% endif %}>Not concierged</option>
      </select>
      <label for="start_date" class="text-gray-700">Start date:</label>
      <input type="date" id="start_date" name="start_date" value="{{ start_date }}" class="border rounded-md px-2 py-1" />
      <label for="end_date" class="text-gray-700">End date:</label>
      <input type="date" id="end_date" name="end_date" value="{{ end_date }}" class="border rounded-md px-2 py-1" />
      <button type="submit" class="px-3 py-1 rounded-md bg-gray-800 text-white">Apply</button>
    </form>
  </div>
</section>

<section class="bg-white shadow-sm border rounded-2xl p-5">
  {% if records %}
  <div class="overflow-x-auto">
    <table class="min-w-[1200px] text-sm">
      <thead>
        <tr class="border-b text-left text-xs uppercase text-gray-600">
          <th class="py-2 pr-3 w-52">Follow-up status</th>
          <th class="py-2 pr-3">
            {% set next_sort = 'employee_id_desc' if sort == 'employee_id_asc' else 'employee_id_asc' %}
            <a class="inline-flex items-center gap-1 hover:underline" href="{{ request.url_for('concierge_page') }}?concierged={{ concierged_filter }}&sort={{ next_sort }}&start_date={{ start_date }}&end_date={{ end_date }}">
              <span>Employee ID</span>
              {% if sort.startswith('employee_id') %}
                <span aria-hidden="true">{{ '↑' if sort == 'employee_id_asc' else '↓' }}</span>
              {% endif %}
            </a>
          </th>
          <th class="py-2 pr-3">Name</th>
          <th class="py-2 pr-3">Start Date</th>
          <th class="py-2 pr-3">Rehire Date</th>
          <th class="py-2 pr-3">Called Date</th>
          <th class="py-2 pr-3"># Calls</th>
          <th class="py-2 pr-3">Recruiter</th>
          <th class="py-2 pr-3">Phone</th>
          <th class="py-2 pr-3">Language</th>
          <th class="py-2 pr-3">Concierged</th>
          <th class="py-2 pr-3"></th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for record in records %}
        {% set form_id = 'update-' ~ record.employee_id|replace(' ', '-') %}
        {% set row_class = follow_up_options.get(record.follow_up_status, {}).get('row_class', '') %}
        <tr class="align-top transition-colors {{ row_class }}" data-row-id="{{ form_id }}">
          <td class="py-3 pr-3 font-medium text-gray-900">
            <select name="follow_up_status" form="{{ form_id }}" class="border rounded-md px-2 py-1 w-full follow-up-select" data-row-id="{{ form_id }}">
              <option value="">Select</option>
              {% for key, option in follow_up_options.items() %}
                <option value="{{ key }}" {% if record.follow_up_status == key %}selected{% endif %}>{{ option.label }}</option>
              {% endfor %}
            </select>
          </td>
          <td class="py-3 pr-3 font-medium text-gray-900">
            {{ record.employee_id }}
            <form id="{{ form_id }}" action="/concierge/update" method="post">
              <input type="hidden" name="employee_id" value="{{ record.employee_id }}" />
              <input type="hidden" name="concierged_filter" value="{{ concierged_filter }}" />
              <input type="hidden" name="sort" value="{{ sort }}" />
              <input type="hidden" name="start_date" value="{{ start_date }}" />
              <input type="hidden" name="end_date" value="{{ end_date }}" />
            </form>
          </td>
          <td class="py-3 pr-3">
            <div class="font-semibold">{{ record.first_name }} {{ record.last_name }}</div>
            <div class="text-xs text-gray-500">Concierge Date: {{ record.concierge_date or '—' }}</div>
          </td>
          <td class="py-3 pr-3">{{ record.start_date or '—' }}</td>
          <td class="py-3 pr-3">{{ record.rehire_date or '—' }}</td>
          <td class="py-3 pr-3">
              <input type="date" name="called_date" form="{{ form_id }}" value="{{ record.called_date }}" class="border rounded-md px-2 py-1 w-40" />
          </td>
          <td class="py-3 pr-3">
              <input type="number" name="call_count" form="{{ form_id }}" min="0" value="{{ record.call_count }}" class="border rounded-md px-2 py-1 w-24" />
          </td>
          <td class="py-3 pr-3">
              <select name="recruiter" form="{{ form_id }}" class="border rounded-md px-2 py-1 w-36">
                <option value="" {% if not record.recruiter %}selected{% endif %}>Select</option>
                {% for recruiter in recruiters %}
                  <option value="{{ recruiter }}" {% if record.recruiter == recruiter %}selected{% endif %}>{{ recruiter }}</option>
                {% endfor %}
              </select>
          </td>
          <td class="py-3 pr-3">{{ record.mobile or '—' }}</td>
          <td class="py-3 pr-3">{{ record.language or '—' }}</td>
          <td class="py-3 pr-3">
              <input type="checkbox" name="concierged" form="{{ form_id }}" {% if record.concierged %}checked{% endif %} class="h-4 w-4" />
          </td>
          <td class="py-3 pr-3 text-right">
              <div class="flex items-center justify-end gap-2">
                <span data-save-status="{{ form_id }}" class="text-xs text-gray-500" aria-live="polite"></span>
                <button type="button" data-save-button="{{ form_id }}" class="px-3 py-1 rounded-md bg-blue-600 text-white">Save</button>
              </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="text-sm text-gray-600">No concierge records yet. Upload a roster to get started.</p>
  {% endif %}
</section>
{% endblock %}
{% block scripts %}
<script id="follow-up-map" type="application/json">{{ follow_up_options | tojson }}</script>
<script>
  (() => {
    const mapElement = document.getElementById('follow-up-map');
    if (!mapElement) return;

    const statusMap = JSON.parse(mapElement.textContent || '{}');
    const allClasses = Object.values(statusMap).map(option => option.row_class).filter(Boolean);

    const applyRowClass = (row, value) => {
      row.classList.remove(...allClasses);
      if (value && statusMap[value] && statusMap[value].row_class) {
        row.classList.add(statusMap[value].row_class);
      }
    };

    document.querySelectorAll('.follow-up-select').forEach(select => {
      const rowId = select.dataset.rowId;
      const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
      if (!row) return;

      applyRowClass(row, select.value);
      select.addEventListener('change', () => applyRowClass(row, select.value));
    });
  })();

  (() => {
    const rows = Array.from(document.querySelectorAll('tr[data-row-id]'));
    if (!rows.length) return;

    const buildFormData = (formId) => {
      const form = document.getElementById(formId);
      const data = new FormData(form);

      document.querySelectorAll(`[name][form="${formId}"]`).forEach((field) => {
        const name = field.getAttribute('name');
        if (!name) return;

        if (field.type === 'checkbox') {
          if (field.checked) {
            data.set(name, field.value || 'on');
          } else {
            data.delete(name);
          }
          return;
        }

        data.set(name, field.value ?? '');
      });

      return data;
    };

    const saveRow = async (formId) => {
      const form = document.getElementById(formId);
      const status = document.querySelector(`[data-save-status="${formId}"]`);
      if (!form || !status) return;

      status.classList.remove('text-red-600', 'text-green-700');
      status.textContent = 'Saving…';

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: { 'Accept': 'application/json' },
          body: buildFormData(formId),
        });

        const payload = await response.json();
        if (!response.ok || payload.error) {
          throw new Error(payload.error || 'Unable to save.');
        }

        status.textContent = payload.notice || 'Saved';
        status.classList.add('text-green-700');
      } catch (error) {
        status.textContent = error.message;
        status.classList.add('text-red-600');
      }
    };

    const registerRow = (row) => {
      const formId = row.dataset.rowId;
      if (!formId) return;

      row.querySelectorAll(`[form="${formId}"]`).forEach((field) => {
        const eventName = field.type === 'checkbox' ? 'change' : 'change';
        field.addEventListener(eventName, () => saveRow(formId));
      });

      const saveButton = row.querySelector(`[data-save-button="${formId}"]`);
      if (saveButton) {
        saveButton.addEventListener('click', (event) => {
          event.preventDefault();
          saveRow(formId);
        });
      }
    };

    rows.forEach(registerRow);
  })();
</script>
{% endblock %}
