{% extends "base.html" %}
{% block title %}Interview Questions — GoLive Tools{% endblock %}
{% block content %}
<section class="max-w-4xl space-y-6">
  <div>
    <h1 class="text-2xl font-semibold mb-2">Interview Questions</h1>
    <p class="text-sm text-gray-700 max-w-2xl">Paste an interview transcript to receive a JSON evaluation you can share with the hiring team.</p>
  </div>

  <div class="p-6 bg-white border border-gray-200 rounded-xl shadow-sm space-y-4">
    <form id="iq-form" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2" for="transcript">Interview transcript</label>
        <textarea
          id="transcript"
          name="transcript"
          rows="12"
          class="w-full border rounded-lg p-3 bg-white shadow-inner focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="Paste the full transcript here..."
          required
        ></textarea>
        <p class="text-xs text-gray-500 mt-1">Include both interviewer questions and candidate answers for the most accurate feedback.</p>
      </div>
      <div class="flex items-center gap-3">
        <button
          type="submit"
          class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-500 disabled:opacity-60"
        >
          Evaluate Interview
        </button>
        <span id="iq-status" class="text-sm text-gray-600" role="status"></span>
      </div>
    </form>

    <div id="iq-result" class="hidden border border-dashed border-gray-300 rounded-lg p-4 bg-gray-50 space-y-4">
      <div class="flex items-center justify-between mb-3">
        <div>
          <p class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Overall Recommendation</p>
          <p id="iq-overall" class="text-lg font-bold text-gray-900">—</p>
          <p id="iq-overall-confidence" class="text-xs text-gray-600">Confidence: —</p>
        </div>
        <button
          id="iq-copy"
          type="button"
          class="px-3 py-1 text-xs font-semibold border rounded-lg bg-white hover:bg-gray-100"
        >
          Copy JSON
        </button>
      </div>

      <div class="p-3 bg-white border rounded-lg shadow-sm space-y-2">
        <p class="text-sm font-semibold text-gray-800">Question Flags</p>
        <ul id="iq-question-flags" class="space-y-2 text-sm text-gray-800">
          <li class="text-gray-500">Waiting for AI response…</li>
        </ul>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-3 bg-white border rounded-lg shadow-sm space-y-2">
          <p class="text-sm font-semibold text-gray-800">Strengths</p>
          <ul id="iq-strengths" class="list-disc list-inside text-sm text-gray-700 space-y-1">
            <li class="text-gray-500">Waiting for AI response…</li>
          </ul>
        </div>
        <div class="p-3 bg-white border rounded-lg shadow-sm space-y-2">
          <p class="text-sm font-semibold text-gray-800">Concerns</p>
          <ul id="iq-concerns" class="list-disc list-inside text-sm text-gray-700 space-y-1">
            <li class="text-gray-500">Waiting for AI response…</li>
          </ul>
        </div>
      </div>

      <div class="p-3 bg-white border rounded-lg shadow-sm space-y-2">
        <p class="text-sm font-semibold text-gray-800">Notes for Hiring Manager</p>
        <p id="iq-notes" class="text-sm text-gray-700">Waiting for AI response…</p>
      </div>

      <div>
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-gray-800">AI JSON Response</h2>
        </div>
        <pre id="iq-output" class="text-xs whitespace-pre-wrap overflow-x-auto"></pre>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  const form = document.getElementById("iq-form");
  const statusEl = document.getElementById("iq-status");
  const resultEl = document.getElementById("iq-result");
  const outputEl = document.getElementById("iq-output");
  const copyBtn = document.getElementById("iq-copy");
  const overallEl = document.getElementById("iq-overall");
  const overallConfidenceEl = document.getElementById("iq-overall-confidence");
  const strengthsEl = document.getElementById("iq-strengths");
  const concernsEl = document.getElementById("iq-concerns");
  const notesEl = document.getElementById("iq-notes");
  const questionFlagsEl = document.getElementById("iq-question-flags");

  function normalizeFlag(flagValue) {
    const normalized = (flagValue || "").toString().trim().toLowerCase();

    if (normalized.includes("green")) {
      return { color: "text-green-500", label: "Green flag" };
    }
    if (normalized.includes("yellow")) {
      return { color: "text-yellow-500", label: "Yellow flag" };
    }
    if (normalized.includes("red")) {
      return { color: "text-red-500", label: "Red flag" };
    }

    return { color: "text-gray-400", label: flagValue || "—" };
  }

  function createFlagIcon(flagValue, { showLabel = false } = {}) {
    const { color, label } = normalizeFlag(flagValue);
    const wrapper = document.createElement("span");
    wrapper.className = "inline-flex items-center gap-2";

    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("viewBox", "0 0 20 20");
    svg.setAttribute("aria-hidden", "true");
    svg.classList.add("h-5", "w-5", color);

    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute(
      "d",
      "M3 2.75A.75.75 0 0 1 3.75 2h6.5a.75.75 0 0 1 .53.22l1.25 1.25h2.97a.75.75 0 0 1 .53 1.28l-1.22 1.22 1.22 1.22a.75.75 0 0 1-.53 1.28h-3a.75.75 0 0 1-.53-.22l-1.25-1.25H4.5v8.25a.75.75 0 0 1-1.5 0z"
    );
    svg.appendChild(path);
    wrapper.appendChild(svg);

    if (showLabel) {
      const labelText = document.createElement("span");
      labelText.textContent = label;
      wrapper.appendChild(labelText);
    } else {
      const srText = document.createElement("span");
      srText.className = "sr-only";
      srText.textContent = label;
      wrapper.appendChild(srText);
    }

    return wrapper;
  }

  function renderList(targetEl, items, emptyLabel) {
    targetEl.innerHTML = "";
    if (!items || items.length === 0) {
      const li = document.createElement("li");
      li.className = "text-gray-500";
      li.textContent = emptyLabel;
      targetEl.appendChild(li);
      return;
    }

    items.forEach((item) => {
      const li = document.createElement("li");
      li.textContent = item;
      targetEl.appendChild(li);
    });
  }

  function formatConfidence(value) {
    if (value === undefined || value === null || Number.isNaN(Number(value))) {
      return "—";
    }
    const numeric = Number(value);
    return `${Math.round(numeric)}%`;
  }

  function renderQuestionFlags(targetEl, entries) {
    targetEl.innerHTML = "";
    if (!entries || entries.length === 0) {
      const li = document.createElement("li");
      li.className = "text-gray-500";
      li.textContent = "No question-level feedback provided.";
      targetEl.appendChild(li);
      return;
    }

    entries.forEach((entry) => {
      const li = document.createElement("li");
      li.className = "p-3 bg-gray-50 border border-gray-200 rounded-lg";

      const header = document.createElement("div");
      header.className = "flex items-start justify-between gap-3";

      const question = document.createElement("div");
      question.className = "text-sm font-semibold text-gray-900";
      question.textContent = entry.question || `Question ${entry.question_number || ""}`;

      const flag = createFlagIcon(entry.flag);
      flag.classList.add("text-xs", "font-semibold", "px-2", "py-1", "rounded-full", "bg-indigo-50");

      header.appendChild(question);
      header.appendChild(flag);

      const confidence = document.createElement("p");
      confidence.className = "text-xs text-gray-600 mt-1";
      confidence.textContent = `Confidence: ${formatConfidence(entry.confidence)}`;

      const rationale = document.createElement("p");
      rationale.className = "text-sm text-gray-700 mt-2";
      rationale.textContent = entry.rationale || "No rationale provided.";

      li.appendChild(header);
      li.appendChild(confidence);
      li.appendChild(rationale);
      targetEl.appendChild(li);
    });
  }

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    resultEl.classList.add("hidden");
    statusEl.textContent = "Submitting transcript...";
    const transcript = (document.getElementById("transcript")?.value || "").trim();

    try {
      const response = await fetch("/interview-questions/evaluate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ transcript })
      });

      if (!response.ok) {
        const payload = await response.json().catch(() => ({}));
        const detail = payload.detail || payload.error || "Request failed.";
        statusEl.textContent = `Error: ${detail}`;
        return;
      }

      const data = await response.json();
      outputEl.textContent = JSON.stringify(data, null, 2);
      const overallFlag = data.overall_recommendation?.flag || data.overall_recommendation;
      overallEl.innerHTML = "";
      overallEl.appendChild(createFlagIcon(overallFlag, { showLabel: true }));
      overallConfidenceEl.textContent = `Confidence: ${formatConfidence(data.overall_recommendation?.confidence)}`;
      renderQuestionFlags(questionFlagsEl, data.question_evaluations);
      renderList(strengthsEl, data.strengths, "No strengths provided.");
      renderList(concernsEl, data.concerns, "No concerns provided.");
      notesEl.textContent = data.notes_for_hiring_manager || "No notes provided.";
      resultEl.classList.remove("hidden");
      statusEl.textContent = "Response received.";
    } catch (error) {
      statusEl.textContent = "Network error. Please try again.";
    }
  });

  copyBtn.addEventListener("click", async () => {
    const text = outputEl.textContent;
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      statusEl.textContent = "Copied to clipboard.";
      setTimeout(() => (statusEl.textContent = ""), 2000);
    } catch (error) {
      statusEl.textContent = "Unable to copy. Please copy manually.";
    }
  });
</script>
{% endblock %}
