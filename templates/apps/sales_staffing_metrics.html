{% extends "base.html" %}
{% block title %}Sales & Staffing Metrics — GoLive Tools{% endblock %}
{% block content %}
<section class="space-y-6">
  <header>
    <h1 class="text-2xl font-semibold text-gray-900">Sales &amp; Staffing Metrics</h1>
    <p class="mt-2 text-sm text-gray-600">
      Choose a Sunday week ending date to review the shift counts and fill rates for the selected week,
      including the two weeks before and the two weeks after.
    </p>
  </header>

  {% if chart_data.weeks %}
    <div class="space-y-6">
      <div>
        <label class="block text-sm font-medium text-gray-700" for="week-ending-select">Week ending</label>
        <select
          id="week-ending-select"
          class="mt-1 w-full rounded-lg border border-gray-300 bg-white p-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
        >
          {% for week in chart_data.weeks %}
            <option value="{{ week.weekEnding }}" {% if chart_data.selectedWeek == week.weekEnding %}selected{% endif %}>
              {{ week.label }}
            </option>
          {% endfor %}
        </select>
        <p class="mt-2 text-xs text-gray-500">
          Week ending values represent shifts worked Monday through Sunday of the selected week.
        </p>
      </div>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900">Shift Count</h2>
          <div class="mt-4 h-72">
            <canvas id="shift-count-chart"></canvas>
          </div>
        </div>
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900">Fill Rate</h2>
          <div class="mt-4 h-72">
            <canvas id="fill-rate-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900">Top 5 Clients</h2>
          <p class="mt-1 text-xs text-gray-500">
            Based on Total Bill revenue for the selected week (Monday through Sunday).
          </p>
          <div class="mt-4 overflow-hidden rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                    Client
                  </th>
                  <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                    Revenue
                  </th>
                  <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                    Avg. Bill Rate
                  </th>
                </tr>
              </thead>
              <tbody id="top-clients-table-body" class="divide-y divide-gray-200 bg-white text-sm text-gray-700">
                <tr>
                  <td colspan="3" class="px-4 py-3 text-center text-sm text-gray-500">
                    Select a week to view top clients.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900">Revenue and Goal</h2>
          <p class="mt-1 text-xs text-gray-500">
            Weekly 2025 revenue performance against goal from the Sales and Staffing workbook.
          </p>
          <div class="mt-4 h-72">
            <canvas id="revenue-goal-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-900">New Sales</h2>
        <p class="mt-1 text-xs text-gray-500">
          New sales revenue and contribution to total revenue for the surrounding weeks of the selected week ending.
        </p>
        <div class="mt-4 h-72">
          <canvas id="new-sales-chart"></canvas>
        </div>
      </div>

      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-900">New Clients</h2>
        <p class="mt-1 text-xs text-gray-500">
          Clients won within six months of the selected week ending with billing activity during that week.
        </p>
        <div class="mt-4 overflow-hidden rounded-lg border border-gray-200">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                  Client
                </th>
                <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                  Total Bill
                </th>
                <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                  Won Date
                </th>
              </tr>
            </thead>
            <tbody id="new-clients-table-body" class="divide-y divide-gray-200 bg-white text-sm text-gray-700">
              <tr>
                <td colspan="3" class="px-4 py-3 text-center text-sm text-gray-500">
                  Select a week to view newly won clients.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="mt-2 text-xs text-gray-500">
          Rows highlighted in green indicate clients won during the selected week.
        </p>
      </div>

      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-900">Revenue by Industry</h2>
        <p class="mt-1 text-xs text-gray-500">
          Revenue totals for each industry in the selected week (Monday through Sunday) sourced from the Payroll 2.csv file.
        </p>
        <div class="mt-4 grid gap-6 lg:grid-cols-2">
          <div>
            <div class="relative h-72">
              <canvas id="industry-bar-chart" class="hidden"></canvas>
              <div
                id="industry-bar-empty"
                class="absolute inset-0 flex items-center justify-center px-6 text-center text-sm text-gray-500"
              >
                No industry revenue data for this week.
              </div>
            </div>
          </div>
          <div>
            <div class="relative h-72">
              <canvas id="industry-pie-chart" class="hidden"></canvas>
              <div
                id="industry-pie-empty"
                class="absolute inset-0 flex items-center justify-center px-6 text-center text-sm text-gray-500"
              >
                No industry revenue data for this week.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
          <div>
            <h2 class="text-base font-semibold text-gray-900">Closed &amp; Upcoming</h2>
            <p class="mt-1 text-xs text-gray-500">
              Track recently closed deals and upcoming opportunities. Add entries using the form fields and save to keep the list up to date.
            </p>
          </div>
          <div class="flex items-center gap-2">
            <button
              type="button"
              data-deal-save
              class="inline-flex items-center rounded-lg border border-transparent bg-indigo-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm transition disabled:cursor-not-allowed disabled:border-gray-200 disabled:bg-gray-100 disabled:text-gray-400"
              disabled
            >
              Save Changes
            </button>
          </div>
        </div>

        <div class="mt-6 grid gap-6 lg:grid-cols-2">
          <section data-deal-section="closed">
            <div class="rounded-lg border border-gray-200">
              <div class="border-b border-gray-200 bg-gray-50 px-4 py-3">
                <h3 class="text-sm font-semibold text-gray-900">Closed</h3>
              </div>
              <div class="p-4">
                <form class="grid gap-3 sm:grid-cols-4" data-deal-form data-deal-type="closed">
                  <div class="sm:col-span-2">
                    <label class="block text-xs font-semibold text-gray-700" for="closed-client-name">Client Name</label>
                    <input
                      id="closed-client-name"
                      name="clientName"
                      type="text"
                      required
                      class="mt-1 w-full rounded-md border border-gray-300 px-2 py-1 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    />
                  </div>
                  <div class="sm:col-span-2">
                    <label class="block text-xs font-semibold text-gray-700" for="closed-location">Location</label>
                    <input
                      id="closed-location"
                      name="location"
                      type="text"
                      required
                      class="mt-1 w-full rounded-md border border-gray-300 px-2 py-1 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    />
                  </div>
                  <div class="sm:col-span-2">
                    <label class="block text-xs font-semibold text-gray-700" for="closed-date">Date</label>
                    <input
                      id="closed-date"
                      name="date"
                      type="date"
                      required
                      class="mt-1 w-full rounded-md border border-gray-300 px-2 py-1 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    />
                  </div>
                  <div class="sm:col-span-2 flex items-end">
                    <button
                      type="submit"
                      class="inline-flex w-full items-center justify-center rounded-md border border-transparent bg-indigo-50 px-3 py-2 text-sm font-semibold text-indigo-700 shadow-sm transition hover:bg-indigo-100"
                    >
                      Add Entry
                    </button>
                  </div>
                </form>

                <div class="mt-4 overflow-hidden rounded-lg border border-gray-200">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                          Client Name
                        </th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                          Location
                        </th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                          Date
                        </th>
                        <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                          Actions
                        </th>
                      </tr>
                    </thead>
                    <tbody data-deal-table-body="closed" class="divide-y divide-gray-200 bg-white text-sm text-gray-700">
                      <tr>
                        <td colspan="4" class="px-4 py-3 text-center text-sm text-gray-500">
                          No entries yet. Add new records using the form above.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <section data-deal-section="upcoming">
            <div class="rounded-lg border border-gray-200">
              <div class="border-b border-gray-200 bg-gray-50 px-4 py-3">
                <h3 class="text-sm font-semibold text-gray-900">Upcoming</h3>
              </div>
              <div class="p-4">
                <form class="grid gap-3 sm:grid-cols-4" data-deal-form data-deal-type="upcoming">
                  <div class="sm:col-span-2">
                    <label class="block text-xs font-semibold text-gray-700" for="upcoming-client-name">Client Name</label>
                    <input
                      id="upcoming-client-name"
                      name="clientName"
                      type="text"
                      required
                      class="mt-1 w-full rounded-md border border-gray-300 px-2 py-1 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    />
                  </div>
                  <div class="sm:col-span-2">
                    <label class="block text-xs font-semibold text-gray-700" for="upcoming-location">Location</label>
                    <input
                      id="upcoming-location"
                      name="location"
                      type="text"
                      required
                      class="mt-1 w-full rounded-md border border-gray-300 px-2 py-1 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    />
                  </div>
                  <div class="sm:col-span-2">
                    <label class="block text-xs font-semibold text-gray-700" for="upcoming-date">Date</label>
                    <input
                      id="upcoming-date"
                      name="date"
                      type="date"
                      required
                      class="mt-1 w-full rounded-md border border-gray-300 px-2 py-1 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    />
                  </div>
                  <div class="sm:col-span-2 flex items-end">
                    <button
                      type="submit"
                      class="inline-flex w-full items-center justify-center rounded-md border border-transparent bg-indigo-50 px-3 py-2 text-sm font-semibold text-indigo-700 shadow-sm transition hover:bg-indigo-100"
                    >
                      Add Entry
                    </button>
                  </div>
                </form>

                <div class="mt-4 overflow-hidden rounded-lg border border-gray-200">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                          Client Name
                        </th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                          Location
                        </th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                          Date
                        </th>
                        <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                          Actions
                        </th>
                      </tr>
                    </thead>
                    <tbody data-deal-table-body="upcoming" class="divide-y divide-gray-200 bg-white text-sm text-gray-700">
                      <tr>
                        <td colspan="4" class="px-4 py-3 text-center text-sm text-gray-500">
                          No entries yet. Add new records using the form above.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
        </div>

        <p data-deal-feedback class="mt-4 text-sm text-gray-500"></p>
      </div>
    </div>
  {% else %}
    <div class="rounded-xl border border-dashed border-gray-300 bg-white p-8 text-center text-sm text-gray-500">
      Upload updated metrics to the <strong>Sales and Staffing Charts.xlsx</strong> workbook to view shift count and fill rate trends.
    </div>
  {% endif %}
</section>

{% if chart_data.weeks %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    if (window.Chart && Chart.defaults && typeof Chart.defaults.set === "function") {
      Chart.defaults.set("plugins.datalabels", { display: false });
    }
  </script>
  <script>
    (function () {
      const chartData = {{ chart_data | tojson(indent=2) | safe }};
      const dealTables = {{ deal_tables | tojson(indent=2) | safe }};
      const weeks = chartData.weeks || [];
      if (!weeks.length) {
        return;
      }

      try {
        if (window.Chart) {
          const pluginIds = (Chart.registry?.plugins?.getAll?.() || []).map((plugin) => plugin.id);
          console.log("Registered plugins:", pluginIds);
        }
      } catch (err) {
        console.warn("Unable to inspect Chart.js plugins", err);
      }

      const selectEl = document.getElementById("week-ending-select");
      const shiftCtx = document.getElementById("shift-count-chart");
      const fillCtx = document.getElementById("fill-rate-chart");
      const revenueCtx = document.getElementById("revenue-goal-chart");
      const newSalesCtx = document.getElementById("new-sales-chart");
      const topClientsTableBody = document.getElementById("top-clients-table-body");
      const newClientsTableBody = document.getElementById("new-clients-table-body");
      const industryBarCtx = document.getElementById("industry-bar-chart");
      const industryPieCtx = document.getElementById("industry-pie-chart");
      const industryBarEmpty = document.getElementById("industry-bar-empty");
      const industryPieEmpty = document.getElementById("industry-pie-empty");
      if (!selectEl || !shiftCtx || !fillCtx) {
        return;
      }

      const windowRadius = 2;

      const topClientsByWeek = chartData.topClientsByWeek || {};
      const revenueSeries = chartData.revenueSeries || [];
      const newClientsByWeek = chartData.newClientsByWeek || {};
      const industryTotalsByWeek = chartData.industryTotalsByWeek || {};

      const revenueSeriesByWeek = new Map(
        revenueSeries.map((entry) => [entry.weekEnding, entry])
      );

      const currencyFormatter = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      });

      const currencyFormatterWithCents = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });

      const industryPalette = [
        "#2563eb",
        "#7c3aed",
        "#059669",
        "#f59e0b",
        "#f97316",
        "#ec4899",
        "#6366f1",
        "#0ea5e9",
        "#10b981",
        "#facc15",
      ];

      const industryPieLabelPlugin = {
        id: "industryPieLabel",
        afterDatasetsDraw(chart) {
          const meta = chart.getDatasetMeta(0);
          // Only run on pie/doughnut charts (meta.type === 'arc').
          if (!meta || meta.type !== "arc") {
            return;
          }

          const dataset = chart.data.datasets[0];
          if (!dataset) {
            return;
          }

          const ctx = chart.ctx;
          const total = dataset.data.reduce((sum, value) => {
            return sum + (typeof value === "number" && Number.isFinite(value) ? value : 0);
          }, 0);

          if (!total) {
            return;
          }

          meta.data.forEach((element, index) => {
            const rawValue = dataset.data[index];
            if (!element || typeof rawValue !== "number" || !Number.isFinite(rawValue)) {
              return;
            }

            const percentage = (rawValue / total) * 100;
            if (percentage < 2) {
              return;
            }

            const label = chart.data.labels[index];
            const percentageLabel = percentage >= 10 ? percentage.toFixed(0) : percentage.toFixed(1);
            const text = `${label} ${percentageLabel}%`;
            const position = element.tooltipPosition();

            ctx.save();
            ctx.font = "12px 'Inter', system-ui, sans-serif";
            ctx.fillStyle = "#374151";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, position.x, position.y);
            ctx.restore();
          });
        },
      };

      Chart.register(industryPieLabelPlugin);
      // --- hard-disable any label-ish plugins that might be loaded globally ---
      (function () {
        // List whatever could be present from base.html or elsewhere
        const idsToDisable = ["datalabels", "labels", "chartjs-plugin-labels", "annotation"];
      
        // 1) Unregister if currently registered
        idsToDisable.forEach((id) => {
          try {
            const plugin = Chart.registry?.plugins?.get?.(id);
            if (plugin) Chart.unregister(plugin);
          } catch (e) {
            // ignore
          }
        });
      
        // 2) Set global defaults to false so even if registered, they're off
        if (Chart.defaults && Chart.defaults.plugins) {
          idsToDisable.forEach((id) => {
            Chart.defaults.plugins[id] = false;
          });
        }
      
        // 3) Double-lock per-chart options by setting to boolean false (not just {display:false})
        //    We'll patch your shared options here so every chart inherits it.
        if (!window.__labelsPluginsDisabledOnce) {
          window.__labelsPluginsDisabledOnce = true;
          const origShared = window.sharedOptions; // not defined yet in your file, so we’ll hook via a getter
          // Monkey-patch Object.defineProperty to inject plugins:false after you create sharedOptions.
          // Safer: just create a global hook you call right after sharedOptions is defined (see below).
          window.__disableLabelPluginsOnOptions = function (opts) {
            opts.plugins = Object.assign({}, opts.plugins, {
              datalabels: false,
              labels: false,
              annotation: false,
            });
            return opts;
          };
        }
      })();

      // Ensure ChartDataLabels (if present) is registered first, then hard-disable it
      if (window.ChartDataLabels) {
        try {
          Chart.register(window.ChartDataLabels);
        } catch (e) {
          /* already registered */
        }
      }
      // Force OFF globally (after all registrations so defaults can't overwrite this)
      if (Chart && Chart.defaults && Chart.defaults.plugins) {
        Chart.defaults.plugins.datalabels = {
          display: false,
          // extra safety: if some dataset sets display:true, this formatter still returns nothing
          formatter: () => "",
          // keep it invisible even if some theme sets a color
          color: "rgba(0,0,0,0)",
        };
      }

      function setIndustryEmptyState(isEmpty) {
        if (industryBarCtx) {
          industryBarCtx.classList.toggle("hidden", isEmpty);
        }
        if (industryBarEmpty) {
          industryBarEmpty.classList.toggle("hidden", !isEmpty);
        }
        if (industryPieCtx) {
          industryPieCtx.classList.toggle("hidden", isEmpty);
        }
        if (industryPieEmpty) {
          industryPieEmpty.classList.toggle("hidden", !isEmpty);
        }
      }

      setIndustryEmptyState(true);

      function formatIndustryLabel(rawLabel) {
        if (typeof rawLabel !== "string") {
          return "Unknown";
        }
        const trimmed = rawLabel.trim();
        if (!trimmed) {
          return "Unknown";
        }
        const withoutSuffix = trimmed.replace(/\s*industry$/i, "").trim();
        return withoutSuffix || trimmed;
      }

      function getWindow(weekEnding) {
        const index = weeks.findIndex((week) => week.weekEnding === weekEnding);
        if (index === -1) {
          return [];
        }
        const start = Math.max(0, index - windowRadius);
        const end = Math.min(weeks.length, index + windowRadius + 1);
        return weeks.slice(start, end);
      }

      function toShiftSeries(windowWeeks, field) {
        return windowWeeks.map((week) => {
          const value = week[field];
          return typeof value === "number" && Number.isFinite(value) ? value : null;
        });
      }

      function toFillSeries(windowWeeks, field) {
        return windowWeeks.map((week) => {
          const value = week[field];
          return typeof value === "number" && Number.isFinite(value) ? value * 100 : null;
        });
      }

      function createLineChart(context, datasets, options) {
        return new Chart(context, {
          type: "line",
          data: {
            labels: [],
            datasets,
          },
          options,
        });
      }

      const disableDataLabels = () => false;

      const sharedOptions = __disableLabelPluginsOnOptions({
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false,
        },
        plugins: {
          legend: {
            position: "bottom",
            labels: { usePointStyle: true },
          },
          datalabels: {
            display: false,
          },
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 0,
            },
          },
          y: {
            beginAtZero: true,
          },
        },
      });

      const shiftChart = createLineChart(
        shiftCtx,
        [
          {
            label: "2024 Shift Count",
            data: [],
            borderColor: "#60a5fa",
            backgroundColor: "#bfdbfe",
            tension: 0.3,
            spanGaps: true,
          },
          {
            label: "2025 Shift Count",
            data: [],
            borderColor: "#2563eb",
            backgroundColor: "#93c5fd",
            tension: 0.3,
            spanGaps: true,
          },
        ],
        {
          ...sharedOptions,
          scales: {
            ...sharedOptions.scales,
            x: {
              ...sharedOptions.scales.x,
              ticks: {
                ...sharedOptions.scales.x.ticks,
                display: true,
              },
            },
            y: {
              ...sharedOptions.scales.y,
              ticks: {
                precision: 0,
              },
            },
          },
        }
      );

      const fillChart = createLineChart(
        fillCtx,
        [
          {
            label: "2024 Fill Rate",
            data: [],
            borderColor: "#34d399",
            backgroundColor: "#a7f3d0",
            tension: 0.3,
            spanGaps: true,
            datalabels: {
              display: disableDataLabels,
            },
          },
          {
            label: "2025 Fill Rate",
            data: [],
            borderColor: "#0d9488",
            backgroundColor: "#5eead4",
            tension: 0.3,
            spanGaps: true,
            datalabels: {
              display: disableDataLabels,
            },
          },
        ],
        {
          ...sharedOptions,
          plugins: {
            ...sharedOptions.plugins,
            tooltip: {
              callbacks: {
                label(context) {
                  if (context.parsed.y == null) {
                    return `${context.dataset.label}: N/A`;
                  }
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                },
              },
            },
          },
          scales: {
            ...sharedOptions.scales,
            x: {
              ...sharedOptions.scales.x,
              ticks: {
                ...sharedOptions.scales.x.ticks,
                display: true,
              },
            },
            y: {
              beginAtZero: false,
              suggestedMin: 80,
              suggestedMax: 100,
              ticks: {
                callback(value) {
                  return `${value}%`;
                },
              },
            },
          },
        }
      );

      const revenueChart =
        revenueCtx && Chart ?
          new Chart(revenueCtx, {
            type: "line",
            data: {
              labels: revenueSeries.map((entry) => entry.label),
              datasets: [
                {
                  label: "2025 Revenue",
                  data: revenueSeries.map((entry) => entry.revenue2025 ?? null),
                  borderColor: "#f97316",
                  backgroundColor: "rgba(249, 115, 22, 0.15)",
                  tension: 0.3,
                  spanGaps: true,
                  datalabels: {
                    display: disableDataLabels,
                  },
                },
                {
                  label: "2025 Revenue Goal",
                  data: revenueSeries.map((entry) => entry.revenueGoal2025 ?? null),
                  borderColor: "#2563eb",
                  backgroundColor: "rgba(37, 99, 235, 0.05)",
                  tension: 0.3,
                  borderDash: [6, 4],
                  spanGaps: true,
                  datalabels: {
                    display: disableDataLabels,
                  },
                },
              ],
            },
            options: {
              ...sharedOptions,
              plugins: {
                ...sharedOptions.plugins,
                tooltip: {
                  callbacks: {
                    label(context) {
                      const value = context.parsed.y;
                      if (value == null) {
                        return `${context.dataset.label}: N/A`;
                      }
                      return `${context.dataset.label}: ${currencyFormatter.format(value)}`;
                    },
                  },
                },
              },
              scales: {
                ...sharedOptions.scales,
                x: {
                  ...sharedOptions.scales.x,
                  ticks: {
                    ...sharedOptions.scales.x.ticks,
                    display: true,
                  },
                },
                y: {
                  ...sharedOptions.scales.y,
                  ticks: {
                    callback(value) {
                      return currencyFormatter.format(value);
                    },
                  },
                },
              },
            },
          })
        : null;

      const newSalesChart =
        newSalesCtx && Chart
          ? new Chart(newSalesCtx, {
              type: "bar",
              data: {
                labels: [],
                datasets: [
                  {
                    type: "bar",
                    label: "New Sales Revenue",
                    data: [],
                    backgroundColor: "rgba(129, 140, 248, 0.35)",
                    borderColor: "#6366f1",
                    borderWidth: 1,
                    yAxisID: "yRevenue",
                    datalabels: {
                      display: false,
                    },
                  },
                  {
                    type: "line",
                    label: "New Sales % of Revenue",
                    data: [],
                    borderColor: "#f59e0b",
                    backgroundColor: "rgba(245, 158, 11, 0.25)",
                    tension: 0.3,
                    spanGaps: true,
                    yAxisID: "yPct",
                    datalabels: {
                      display: false,
                    },
                  },
                ],
              },
              options: {
                ...sharedOptions,
                scales: {
                  x: {
                    ...sharedOptions.scales.x,
                    ticks: {
                      ...sharedOptions.scales.x.ticks,
                      display: true,
                    },
                    grid: {
                      display: false,
                    },
                  },
                  yRevenue: {
                    position: "left",
                    beginAtZero: true,
                    ticks: {
                      callback(value) {
                        return currencyFormatter.format(value);
                      },
                    },
                  },
                  yPct: {
                    position: "right",
                    beginAtZero: true,
                    grid: {
                      drawOnChartArea: false,
                    },
                    ticks: {
                      callback(value) {
                        return `${value}%`;
                      },
                    },
                  },
                },
                plugins: {
                  ...sharedOptions.plugins,
                  tooltip: {
                    callbacks: {
                      label(context) {
                        if (context.dataset.yAxisID === "yRevenue") {
                          const value = context.parsed.y;
                          if (value == null) {
                            return `${context.dataset.label}: N/A`;
                          }
                          return `${context.dataset.label}: ${currencyFormatter.format(value)}`;
                        }
                        if (context.dataset.yAxisID === "yPct") {
                          const value = context.parsed.y;
                          if (value == null) {
                            return `${context.dataset.label}: N/A`;
                          }
                          return `${context.dataset.label}: ${value.toFixed(1)}%`;
                        }
                        return `${context.dataset.label}: ${context.formattedValue}`;
                      },
                    },
                  },
                },
              },
            })
          : null;

      const industryBarChart =
        industryBarCtx && Chart
          ? new Chart(industryBarCtx, {
              type: "bar",
              data: {
                labels: [],
                datasets: [
                  {
                    label: "Revenue",
                    data: [],
                    backgroundColor: [],
                    borderRadius: 6,
                    datalabels: {
                      display: false,
                    },
                  },
                ],
              },
              options: {
                ...sharedOptions,
                indexAxis: "y",
                plugins: {
                  ...sharedOptions.plugins,
                  legend: {
                    display: false,
                  },
                  tooltip: {
                    callbacks: {
                      label(context) {
                        const value = context.parsed.x ?? context.parsed.y ?? 0;
                        return `${context.label}: ${currencyFormatter.format(value)}`;
                      },
                    },
                  },
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    ticks: {
                      callback(value) {
                        return currencyFormatter.format(value);
                      },
                    },
                  },
                  y: {
                    ticks: {
                      autoSkip: false,
                    },
                  },
                },
              },
            })
          : null;

      const industryPieChart =
        industryPieCtx && Chart
          ? new Chart(industryPieCtx, {
              type: "pie",
              data: {
                labels: [],
                datasets: [
                  {
                    label: "Revenue Share",
                    data: [],
                    backgroundColor: [],
                    borderWidth: 1,
                    datalabels: {
                      display: false,
                    },
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false,
                  },
                  tooltip: {
                    callbacks: {
                      label(context) {
                        const value = context.parsed ?? 0;
                        const dataset = context.chart.data.datasets[context.datasetIndex];
                        const total = dataset.data.reduce((sum, entry) => {
                          return sum + (typeof entry === "number" && Number.isFinite(entry) ? entry : 0);
                        }, 0);
                        const percentage = total > 0 ? (value / total) * 100 : 0;
                        const pctLabel = percentage >= 10 ? percentage.toFixed(0) : percentage.toFixed(1);
                        return `${context.label}: ${currencyFormatter.format(value)} (${pctLabel}%)`;
                      },
                    },
                  },
                },
              },
            })
          : null;

      function updateTopClients(weekEnding) {
        if (!topClientsTableBody) {
          return;
        }

        const clients = topClientsByWeek[weekEnding] || [];

        topClientsTableBody.innerHTML = "";

        if (!clients.length) {
          const emptyRow = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.className = "px-4 py-3 text-center text-sm text-gray-500";
          cell.textContent = "No client billing activity for this week.";
          emptyRow.appendChild(cell);
          topClientsTableBody.appendChild(emptyRow);
          return;
        }

        clients.forEach((entry) => {
          const revenue = entry.revenue ?? entry.totalBill ?? 0;
          const averageBillRate = entry.averageBillRate;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="px-4 py-2">${entry.client}</td>
            <td class="px-4 py-2 text-right font-medium">${currencyFormatter.format(
              revenue || 0
            )}</td>
            <td class="px-4 py-2 text-right text-gray-600">${
              averageBillRate != null
                ? currencyFormatterWithCents.format(averageBillRate)
                : "—"
            }</td>
          `;
          topClientsTableBody.appendChild(row);
        });
      }

      function updateNewClients(weekEnding) {
        if (!newClientsTableBody) {
          return;
        }

        const clients = newClientsByWeek[weekEnding] || [];
        newClientsTableBody.innerHTML = "";

        if (!clients.length) {
          const emptyRow = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.className = "px-4 py-3 text-center text-sm text-gray-500";
          cell.textContent = "No newly won clients with billing for this week.";
          emptyRow.appendChild(cell);
          newClientsTableBody.appendChild(emptyRow);
          return;
        }

        clients.forEach((entry) => {
          const row = document.createElement("tr");
          if (entry.isHighlighted) {
            row.classList.add("bg-green-50");
          }
          row.innerHTML = `
            <td class="px-4 py-2">${entry.client}</td>
            <td class="px-4 py-2 text-right font-medium">${currencyFormatter.format(
              entry.totalBill || 0
            )}</td>
            <td class="px-4 py-2 text-right text-gray-600">${
              entry.wonDateLabel ?? "—"
            }</td>
          `;
          newClientsTableBody.appendChild(row);
        });
      }

      function updateIndustryCharts(weekEnding) {
        const entries = (industryTotalsByWeek[weekEnding] || []).map((entry) => {
          const value =
            typeof entry.totalBill === "number" && Number.isFinite(entry.totalBill)
              ? entry.totalBill
              : Number.parseFloat(entry.totalBill) || 0;
          const industryLabel = formatIndustryLabel(
            entry && typeof entry.industry === "string" ? entry.industry : ""
          );
          return {
            industry: industryLabel,
            totalBill: Number.isFinite(value) ? value : 0,
          };
        });

        const shouldShowCharts = entries.length > 0;
        setIndustryEmptyState(!shouldShowCharts);

        const labels = entries.map((entry) => entry.industry);
        const values = entries.map((entry) => entry.totalBill);
        const colors = labels.map((_, index) => industryPalette[index % industryPalette.length]);

        if (industryBarChart) {
          industryBarChart.data.labels = labels;
          industryBarChart.data.datasets[0].data = values;
          industryBarChart.data.datasets[0].backgroundColor = colors;
          industryBarChart.update();
        }

        if (industryPieChart) {
          industryPieChart.data.labels = labels;
          industryPieChart.data.datasets[0].data = values;
          industryPieChart.data.datasets[0].backgroundColor = colors;
          industryPieChart.update();
        }
      }

      function updateCharts(weekEnding) {
        const windowWeeks = getWindow(weekEnding);
        const labels = windowWeeks.map((week) => week.label);

        shiftChart.data.labels = labels;
        shiftChart.data.datasets[0].data = toShiftSeries(windowWeeks, "shiftCount2024");
        shiftChart.data.datasets[1].data = toShiftSeries(windowWeeks, "shiftCount2025");
        shiftChart.update();

        fillChart.data.labels = labels;
        fillChart.data.datasets[0].data = toFillSeries(windowWeeks, "fillRate2024");
        fillChart.data.datasets[1].data = toFillSeries(windowWeeks, "fillRate2025");
        fillChart.update();

        if (newSalesChart) {
          newSalesChart.data.labels = labels;
          newSalesChart.data.datasets[0].data = windowWeeks.map((week) => {
            const series = revenueSeriesByWeek.get(week.weekEnding) || {};
            const value = series.newSalesRevenue;
            return typeof value === "number" && Number.isFinite(value) ? value : null;
          });
          newSalesChart.data.datasets[1].data = windowWeeks.map((week) => {
            const series = revenueSeriesByWeek.get(week.weekEnding) || {};
            const value = series.newSalesPct;
            if (typeof value !== "number" || !Number.isFinite(value)) {
              return null;
            }
            return value > 1 ? value : value * 100;
          });
          newSalesChart.update();
        }

        updateTopClients(weekEnding);
        updateNewClients(weekEnding);
        updateIndustryCharts(weekEnding);
      }

      function normalizeDealEntry(entry) {
        if (!entry || typeof entry !== "object") {
          return { clientName: "", location: "", date: "" };
        }
        return {
          clientName: typeof entry.clientName === "string" ? entry.clientName : "",
          location: typeof entry.location === "string" ? entry.location : "",
          date: typeof entry.date === "string" ? entry.date : "",
        };
      }

      const dealState = {
        closed: Array.isArray(dealTables.closed) ? dealTables.closed.map((entry) => normalizeDealEntry(entry)) : [],
        upcoming: Array.isArray(dealTables.upcoming) ? dealTables.upcoming.map((entry) => normalizeDealEntry(entry)) : [],
      };

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const dateFormatter = new Intl.DateTimeFormat("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
      });

      const saveButtons = Array.from(document.querySelectorAll("[data-deal-save]"));
      const feedbackEl = document.querySelector("[data-deal-feedback]");
      let dealsDirty = false;
      let isSaving = false;

      const dealsUrl = `${window.location.pathname.replace(/\/$/, "")}/deals`;

      function parseDealDate(value) {
        if (!value) {
          return null;
        }
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) {
          return null;
        }
        parsed.setHours(0, 0, 0, 0);
        return parsed;
      }

      function sortDealEntries(entries) {
        entries.sort((a, b) => {
          const aDate = parseDealDate(a.date);
          const bDate = parseDealDate(b.date);
          if (!aDate && !bDate) {
            return 0;
          }
          if (!aDate) {
            return 1;
          }
          if (!bDate) {
            return -1;
          }
          const aDiff = Math.abs(aDate.getTime() - today.getTime());
          const bDiff = Math.abs(bDate.getTime() - today.getTime());
          if (aDiff !== bDiff) {
            return aDiff - bDiff;
          }
          return aDate.getTime() - bDate.getTime();
        });
      }

      function renderDealTable(section) {
        const body = document.querySelector(`[data-deal-table-body="${section}"]`);
        if (!body) {
          return;
        }

        const entries = dealState[section] || [];
        body.innerHTML = "";

        if (!entries.length) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 4;
          cell.className = "px-4 py-3 text-center text-sm text-gray-500";
          cell.textContent = "No entries yet. Add new records using the form above.";
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        entries.forEach((entry, index) => {
          const row = document.createElement("tr");

          const clientCell = document.createElement("td");
          clientCell.className = "px-4 py-2";
          clientCell.textContent = entry.clientName || "—";

          const locationCell = document.createElement("td");
          locationCell.className = "px-4 py-2";
          locationCell.textContent = entry.location || "—";

          const dateCell = document.createElement("td");
          dateCell.className = "px-4 py-2";
          const parsedDate = parseDealDate(entry.date);
          dateCell.textContent = parsedDate ? dateFormatter.format(parsedDate) : entry.date || "—";

          const actionCell = document.createElement("td");
          actionCell.className = "px-4 py-2 text-right";
          const deleteButton = document.createElement("button");
          deleteButton.type = "button";
          deleteButton.className =
            "inline-flex items-center rounded-md border border-transparent bg-red-50 px-2 py-1 text-xs font-semibold text-red-600 transition hover:bg-red-100";
          deleteButton.textContent = "Delete";
          deleteButton.dataset.dealDelete = "true";
          deleteButton.dataset.dealType = section;
          deleteButton.dataset.entryIndex = String(index);
          actionCell.appendChild(deleteButton);

          row.appendChild(clientCell);
          row.appendChild(locationCell);
          row.appendChild(dateCell);
          row.appendChild(actionCell);

          body.appendChild(row);
        });
      }

      function updateSaveButtons() {
        saveButtons.forEach((button) => {
          if (!button) {
            return;
          }
          button.disabled = !dealsDirty || isSaving;
        });
      }

      function showDealFeedback(message, tone = "info") {
        if (!feedbackEl) {
          return;
        }
        feedbackEl.textContent = message;
        feedbackEl.classList.remove("text-green-600", "text-red-600", "text-gray-500");
        if (!message) {
          feedbackEl.classList.add("text-gray-500");
          return;
        }
        if (tone === "success") {
          feedbackEl.classList.add("text-green-600");
        } else if (tone === "error") {
          feedbackEl.classList.add("text-red-600");
        } else {
          feedbackEl.classList.add("text-gray-500");
        }
      }

      function refreshDealTables() {
        sortDealEntries(dealState.closed);
        sortDealEntries(dealState.upcoming);
        renderDealTable("closed");
        renderDealTable("upcoming");
      }

      function markDealsDirty() {
        dealsDirty = true;
        updateSaveButtons();
      }

      refreshDealTables();
      updateSaveButtons();

      document.querySelectorAll("[data-deal-form]").forEach((form) => {
        form.addEventListener("submit", (event) => {
          event.preventDefault();
          const formEl = event.currentTarget;
          if (!(formEl instanceof HTMLFormElement)) {
            return;
          }
          if (!formEl.reportValidity()) {
            return;
          }

          const type = formEl.dataset.dealType;
          if (!type || !dealState[type]) {
            return;
          }

          const formData = new FormData(formEl);
          const clientName = (formData.get("clientName") || "").toString().trim();
          const location = (formData.get("location") || "").toString().trim();
          const dateValue = (formData.get("date") || "").toString();

          if (!clientName || !location || !dateValue) {
            return;
          }

          dealState[type].push({
            clientName,
            location,
            date: dateValue,
          });

          formEl.reset();
          refreshDealTables();
          markDealsDirty();
          showDealFeedback("Entry added. Remember to save your changes.");
        });
      });

      document.querySelectorAll("[data-deal-table-body]").forEach((body) => {
        body.addEventListener("click", (event) => {
          const target = event.target instanceof HTMLElement ? event.target.closest("[data-deal-delete]") : null;
          if (!target) {
            return;
          }
          const type = target.dataset.dealType;
          const index = Number.parseInt(target.dataset.entryIndex || "", 10);
          if (!type || !dealState[type] || Number.isNaN(index)) {
            return;
          }
          dealState[type].splice(index, 1);
          refreshDealTables();
          markDealsDirty();
          showDealFeedback("Entry removed. Save to keep your tables updated.");
        });
      });

      async function saveDealTables() {
        if (isSaving || !dealsDirty) {
          return;
        }

        isSaving = true;
        updateSaveButtons();
        showDealFeedback("Saving changes…");

        try {
          const response = await fetch(dealsUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              closed: dealState.closed,
              upcoming: dealState.upcoming,
            }),
          });

          if (!response.ok) {
            let detail = "Unable to save changes. Please try again.";
            try {
              const errorPayload = await response.json();
              if (errorPayload && typeof errorPayload.detail === "string") {
                detail = errorPayload.detail;
              }
            } catch (error) {
              // ignore JSON parsing errors
            }
            throw new Error(detail);
          }

          const payload = await response.json();
          const nextClosed = Array.isArray(payload.closed)
            ? payload.closed.map((entry) => normalizeDealEntry(entry))
            : [];
          const nextUpcoming = Array.isArray(payload.upcoming)
            ? payload.upcoming.map((entry) => normalizeDealEntry(entry))
            : [];
          dealState.closed = nextClosed;
          dealState.upcoming = nextUpcoming;
          dealsDirty = false;
          refreshDealTables();
          showDealFeedback("Changes saved.", "success");
        } catch (error) {
          console.error(error);
          showDealFeedback(error instanceof Error ? error.message : "Unable to save changes. Please try again.", "error");
        } finally {
          isSaving = false;
          updateSaveButtons();
        }
      }

      saveButtons.forEach((button) => {
        button.addEventListener("click", () => {
          void saveDealTables();
        });
      });

      const initialWeek = chartData.selectedWeek || weeks[weeks.length - 1].weekEnding;
      if (selectEl.value !== initialWeek) {
        selectEl.value = initialWeek;
      }
      updateCharts(initialWeek);

      selectEl.addEventListener("change", (event) => {
        updateCharts(event.target.value);
      });
    })();
  </script>
{% endif %}
{% endblock %}
