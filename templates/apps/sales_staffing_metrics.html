{% extends "base.html" %}
{% block title %}Sales & Staffing Metrics — GoLive Tools{% endblock %}
{% block content %}
<section class="space-y-6">
  <header>
    <h1 class="text-2xl font-semibold text-gray-900">Sales &amp; Staffing Metrics</h1>
    <p class="mt-2 text-sm text-gray-600">
      Choose a Sunday week ending date to review the shift counts and fill rates for the selected week,
      including the two weeks before and the two weeks after.
    </p>
  </header>

  {% if chart_data.weeks %}
    <div class="space-y-6">
      <div>
        <label class="block text-sm font-medium text-gray-700" for="week-ending-select">Week ending</label>
        <select
          id="week-ending-select"
          class="mt-1 w-full rounded-lg border border-gray-300 bg-white p-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
        >
          {% for week in chart_data.weeks %}
            <option value="{{ week.weekEnding }}" {% if chart_data.selectedWeek == week.weekEnding %}selected{% endif %}>
              {{ week.label }}
            </option>
          {% endfor %}
        </select>
        <p class="mt-2 text-xs text-gray-500">
          Week ending values represent shifts worked Monday through Sunday of the selected week.
        </p>
      </div>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900">Shift Count</h2>
          <div class="mt-4 h-72">
            <canvas id="shift-count-chart"></canvas>
          </div>
        </div>
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900">Fill Rate</h2>
          <div class="mt-4 h-72">
            <canvas id="fill-rate-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900">Top 5 Clients</h2>
          <p class="mt-1 text-xs text-gray-500">
            Based on Total Bill revenue for the selected week (Monday through Sunday).
          </p>
          <div class="mt-4 overflow-hidden rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                    Client
                  </th>
                  <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                    Revenue
                  </th>
                  <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                    Avg. Bill Rate
                  </th>
                </tr>
              </thead>
              <tbody id="top-clients-table-body" class="divide-y divide-gray-200 bg-white text-sm text-gray-700">
                <tr>
                  <td colspan="3" class="px-4 py-3 text-center text-sm text-gray-500">
                    Select a week to view top clients.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900">Revenue and Goal</h2>
          <p class="mt-1 text-xs text-gray-500">
            Weekly 2025 revenue performance against goal from the Sales and Staffing workbook.
          </p>
          <div class="mt-4 h-72">
            <canvas id="revenue-goal-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-900">New Sales</h2>
        <p class="mt-1 text-xs text-gray-500">
          New sales revenue and contribution to total revenue for the surrounding weeks of the selected week ending.
        </p>
        <div class="mt-4 h-72">
          <canvas id="new-sales-chart"></canvas>
        </div>
      </div>

      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-900">New Clients</h2>
        <p class="mt-1 text-xs text-gray-500">
          Clients won within six months of the selected week ending with billing activity during that week.
        </p>
        <div class="mt-4 overflow-hidden rounded-lg border border-gray-200">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                  Client
                </th>
                <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                  Total Bill
                </th>
                <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                  Won Date
                </th>
              </tr>
            </thead>
            <tbody id="new-clients-table-body" class="divide-y divide-gray-200 bg-white text-sm text-gray-700">
              <tr>
                <td colspan="3" class="px-4 py-3 text-center text-sm text-gray-500">
                  Select a week to view newly won clients.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="mt-2 text-xs text-gray-500">
          Rows highlighted in green indicate clients won during the selected week.
        </p>
      </div>
    </div>
  {% else %}
    <div class="rounded-xl border border-dashed border-gray-300 bg-white p-8 text-center text-sm text-gray-500">
      Upload updated metrics to the <strong>Sales and Staffing Charts.xlsx</strong> workbook to view shift count and fill rate trends.
    </div>
  {% endif %}
</section>

{% if chart_data.weeks %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    (function () {
      const chartData = {{ chart_data | tojson(indent=2) | safe }};
      const weeks = chartData.weeks || [];
      if (!weeks.length) {
        return;
      }

      const selectEl = document.getElementById("week-ending-select");
      const shiftCtx = document.getElementById("shift-count-chart");
      const fillCtx = document.getElementById("fill-rate-chart");
      const revenueCtx = document.getElementById("revenue-goal-chart");
      const newSalesCtx = document.getElementById("new-sales-chart");
      const topClientsTableBody = document.getElementById("top-clients-table-body");
      const newClientsTableBody = document.getElementById("new-clients-table-body");
      if (!selectEl || !shiftCtx || !fillCtx) {
        return;
      }

      const windowRadius = 2;

      const topClientsByWeek = chartData.topClientsByWeek || {};
      const revenueSeries = chartData.revenueSeries || [];
      const newClientsByWeek = chartData.newClientsByWeek || {};

      const revenueSeriesByWeek = new Map(
        revenueSeries.map((entry) => [entry.weekEnding, entry])
      );

      const currencyFormatter = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      });

      const currencyFormatterWithCents = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });

      function getWindow(weekEnding) {
        const index = weeks.findIndex((week) => week.weekEnding === weekEnding);
        if (index === -1) {
          return [];
        }
        const start = Math.max(0, index - windowRadius);
        const end = Math.min(weeks.length, index + windowRadius + 1);
        return weeks.slice(start, end);
      }

      function toShiftSeries(windowWeeks, field) {
        return windowWeeks.map((week) => {
          const value = week[field];
          return typeof value === "number" && Number.isFinite(value) ? value : null;
        });
      }

      function toFillSeries(windowWeeks, field) {
        return windowWeeks.map((week) => {
          const value = week[field];
          return typeof value === "number" && Number.isFinite(value) ? value * 100 : null;
        });
      }

      function createLineChart(context, datasets, options) {
        return new Chart(context, {
          type: "line",
          data: {
            labels: [],
            datasets,
          },
          options,
        });
      }

      const sharedOptions = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false,
        },
        plugins: {
          legend: {
            position: "bottom",
            labels: { usePointStyle: true },
          },
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 0,
            },
          },
          y: {
            beginAtZero: true,
          },
        },
      };

      const shiftChart = createLineChart(
        shiftCtx,
        [
          {
            label: "2024 Shift Count",
            data: [],
            borderColor: "#60a5fa",
            backgroundColor: "#bfdbfe",
            tension: 0.3,
            spanGaps: true,
          },
          {
            label: "2025 Shift Count",
            data: [],
            borderColor: "#2563eb",
            backgroundColor: "#93c5fd",
            tension: 0.3,
            spanGaps: true,
          },
        ],
        {
          ...sharedOptions,
          scales: {
            ...sharedOptions.scales,
            y: {
              ...sharedOptions.scales.y,
              ticks: {
                precision: 0,
              },
            },
          },
        }
      );

      const fillChart = createLineChart(
        fillCtx,
        [
          {
            label: "2024 Fill Rate",
            data: [],
            borderColor: "#34d399",
            backgroundColor: "#a7f3d0",
            tension: 0.3,
            spanGaps: true,
          },
          {
            label: "2025 Fill Rate",
            data: [],
            borderColor: "#0d9488",
            backgroundColor: "#5eead4",
            tension: 0.3,
            spanGaps: true,
          },
        ],
        {
          ...sharedOptions,
          plugins: {
            ...sharedOptions.plugins,
            tooltip: {
              callbacks: {
                label(context) {
                  if (context.parsed.y == null) {
                    return `${context.dataset.label}: N/A`;
                  }
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                },
              },
            },
          },
          scales: {
            ...sharedOptions.scales,
            y: {
              beginAtZero: true,
              suggestedMax: 100,
              ticks: {
                callback(value) {
                  return `${value}%`;
                },
              },
            },
          },
        }
      );

      const revenueChart =
        revenueCtx && Chart ?
          new Chart(revenueCtx, {
            type: "line",
            data: {
              labels: revenueSeries.map((entry) => entry.label),
              datasets: [
                {
                  label: "2025 Revenue",
                  data: revenueSeries.map((entry) => entry.revenue2025 ?? null),
                  borderColor: "#f97316",
                  backgroundColor: "rgba(249, 115, 22, 0.15)",
                  tension: 0.3,
                  spanGaps: true,
                },
                {
                  label: "2025 Revenue Goal",
                  data: revenueSeries.map((entry) => entry.revenueGoal2025 ?? null),
                  borderColor: "#2563eb",
                  backgroundColor: "rgba(37, 99, 235, 0.05)",
                  tension: 0.3,
                  borderDash: [6, 4],
                  spanGaps: true,
                },
              ],
            },
            options: {
              ...sharedOptions,
              plugins: {
                ...sharedOptions.plugins,
                tooltip: {
                  callbacks: {
                    label(context) {
                      const value = context.parsed.y;
                      if (value == null) {
                        return `${context.dataset.label}: N/A`;
                      }
                      return `${context.dataset.label}: ${currencyFormatter.format(value)}`;
                    },
                  },
                },
              },
              scales: {
                ...sharedOptions.scales,
                y: {
                  ...sharedOptions.scales.y,
                  ticks: {
                    callback(value) {
                      return currencyFormatter.format(value);
                    },
                  },
                },
              },
            },
          })
        : null;

      const newSalesChart =
        newSalesCtx && Chart
          ? new Chart(newSalesCtx, {
              type: "bar",
              data: {
                labels: [],
                datasets: [
                  {
                    type: "bar",
                    label: "New Sales Revenue",
                    data: [],
                    backgroundColor: "rgba(129, 140, 248, 0.35)",
                    borderColor: "#6366f1",
                    borderWidth: 1,
                    yAxisID: "yRevenue",
                  },
                  {
                    type: "line",
                    label: "New Sales % of Revenue",
                    data: [],
                    borderColor: "#f59e0b",
                    backgroundColor: "rgba(245, 158, 11, 0.25)",
                    tension: 0.3,
                    spanGaps: true,
                    yAxisID: "yPct",
                  },
                ],
              },
              options: {
                ...sharedOptions,
                scales: {
                  x: {
                    ...sharedOptions.scales.x,
                  },
                  yRevenue: {
                    position: "left",
                    beginAtZero: true,
                    ticks: {
                      callback(value) {
                        return currencyFormatter.format(value);
                      },
                    },
                  },
                  yPct: {
                    position: "right",
                    beginAtZero: true,
                    grid: {
                      drawOnChartArea: false,
                    },
                    ticks: {
                      callback(value) {
                        return `${value}%`;
                      },
                    },
                  },
                },
                plugins: {
                  ...sharedOptions.plugins,
                  tooltip: {
                    callbacks: {
                      label(context) {
                        if (context.dataset.yAxisID === "yRevenue") {
                          const value = context.parsed.y;
                          if (value == null) {
                            return `${context.dataset.label}: N/A`;
                          }
                          return `${context.dataset.label}: ${currencyFormatter.format(value)}`;
                        }
                        if (context.dataset.yAxisID === "yPct") {
                          const value = context.parsed.y;
                          if (value == null) {
                            return `${context.dataset.label}: N/A`;
                          }
                          return `${context.dataset.label}: ${value.toFixed(1)}%`;
                        }
                        return `${context.dataset.label}: ${context.formattedValue}`;
                      },
                    },
                  },
                },
              },
            })
          : null;

      function updateTopClients(weekEnding) {
        if (!topClientsTableBody) {
          return;
        }

        const clients = topClientsByWeek[weekEnding] || [];

        topClientsTableBody.innerHTML = "";

        if (!clients.length) {
          const emptyRow = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.className = "px-4 py-3 text-center text-sm text-gray-500";
          cell.textContent = "No client billing activity for this week.";
          emptyRow.appendChild(cell);
          topClientsTableBody.appendChild(emptyRow);
          return;
        }

        clients.forEach((entry) => {
          const revenue = entry.revenue ?? entry.totalBill ?? 0;
          const averageBillRate = entry.averageBillRate;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="px-4 py-2">${entry.client}</td>
            <td class="px-4 py-2 text-right font-medium">${currencyFormatter.format(
              revenue || 0
            )}</td>
            <td class="px-4 py-2 text-right text-gray-600">${
              averageBillRate != null
                ? currencyFormatterWithCents.format(averageBillRate)
                : "—"
            }</td>
          `;
          topClientsTableBody.appendChild(row);
        });
      }

      function updateNewClients(weekEnding) {
        if (!newClientsTableBody) {
          return;
        }

        const clients = newClientsByWeek[weekEnding] || [];
        newClientsTableBody.innerHTML = "";

        if (!clients.length) {
          const emptyRow = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.className = "px-4 py-3 text-center text-sm text-gray-500";
          cell.textContent = "No newly won clients with billing for this week.";
          emptyRow.appendChild(cell);
          newClientsTableBody.appendChild(emptyRow);
          return;
        }

        clients.forEach((entry) => {
          const row = document.createElement("tr");
          if (entry.isHighlighted) {
            row.classList.add("bg-green-50");
          }
          row.innerHTML = `
            <td class="px-4 py-2">${entry.client}</td>
            <td class="px-4 py-2 text-right font-medium">${currencyFormatter.format(
              entry.totalBill || 0
            )}</td>
            <td class="px-4 py-2 text-right text-gray-600">${
              entry.wonDateLabel ?? "—"
            }</td>
          `;
          newClientsTableBody.appendChild(row);
        });
      }

      function updateCharts(weekEnding) {
        const windowWeeks = getWindow(weekEnding);
        const labels = windowWeeks.map((week) => week.label);

        shiftChart.data.labels = labels;
        shiftChart.data.datasets[0].data = toShiftSeries(windowWeeks, "shiftCount2024");
        shiftChart.data.datasets[1].data = toShiftSeries(windowWeeks, "shiftCount2025");
        shiftChart.update();

        fillChart.data.labels = labels;
        fillChart.data.datasets[0].data = toFillSeries(windowWeeks, "fillRate2024");
        fillChart.data.datasets[1].data = toFillSeries(windowWeeks, "fillRate2025");
        fillChart.update();

        if (newSalesChart) {
          newSalesChart.data.labels = labels;
          newSalesChart.data.datasets[0].data = windowWeeks.map((week) => {
            const series = revenueSeriesByWeek.get(week.weekEnding) || {};
            const value = series.newSalesRevenue;
            return typeof value === "number" && Number.isFinite(value) ? value : null;
          });
          newSalesChart.data.datasets[1].data = windowWeeks.map((week) => {
            const series = revenueSeriesByWeek.get(week.weekEnding) || {};
            const value = series.newSalesPct;
            if (typeof value !== "number" || !Number.isFinite(value)) {
              return null;
            }
            return value > 1 ? value : value * 100;
          });
          newSalesChart.update();
        }

        updateTopClients(weekEnding);
        updateNewClients(weekEnding);
      }

      const initialWeek = chartData.selectedWeek || weeks[weeks.length - 1].weekEnding;
      if (selectEl.value !== initialWeek) {
        selectEl.value = initialWeek;
      }
      updateCharts(initialWeek);

      selectEl.addEventListener("change", (event) => {
        updateCharts(event.target.value);
      });
    })();
  </script>
{% endif %}
{% endblock %}
