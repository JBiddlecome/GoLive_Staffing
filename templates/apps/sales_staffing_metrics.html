{% extends "base.html" %}
{% block title %}Sales & Staffing Metrics â€” GoLive Tools{% endblock %}
{% block content %}
<section class="space-y-6">
  <header>
    <h1 class="text-2xl font-semibold text-gray-900">Sales &amp; Staffing Metrics</h1>
    <p class="mt-2 text-sm text-gray-600">
      Choose a Sunday week ending date to review the shift counts and fill rates for the selected week,
      including the two weeks before and the two weeks after.
    </p>
  </header>

  {% if chart_data.weeks %}
    <div class="space-y-6">
      <div>
        <label class="block text-sm font-medium text-gray-700" for="week-ending-select">Week ending</label>
        <select
          id="week-ending-select"
          class="mt-1 w-full rounded-lg border border-gray-300 bg-white p-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
        >
          {% for week in chart_data.weeks %}
            <option value="{{ week.weekEnding }}" {% if chart_data.selectedWeek == week.weekEnding %}selected{% endif %}>
              {{ week.label }}
            </option>
          {% endfor %}
        </select>
        <p class="mt-2 text-xs text-gray-500">
          Week ending values represent shifts worked Monday through Sunday of the selected week.
        </p>
      </div>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900">Shift Count</h2>
          <div class="mt-4 h-72">
            <canvas id="shift-count-chart"></canvas>
          </div>
        </div>
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900">Fill Rate</h2>
          <div class="mt-4 h-72">
            <canvas id="fill-rate-chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="rounded-xl border border-dashed border-gray-300 bg-white p-8 text-center text-sm text-gray-500">
      Upload updated metrics to the <strong>Sales and Staffing Charts.xlsx</strong> workbook to view shift count and fill rate trends.
    </div>
  {% endif %}
</section>

{% if chart_data.weeks %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    (function () {
      const chartData = {{ chart_data | tojson(indent=2) | safe }};
      const weeks = chartData.weeks || [];
      if (!weeks.length) {
        return;
      }

      const selectEl = document.getElementById("week-ending-select");
      const shiftCtx = document.getElementById("shift-count-chart");
      const fillCtx = document.getElementById("fill-rate-chart");
      if (!selectEl || !shiftCtx || !fillCtx) {
        return;
      }

      const windowRadius = 2;

      function getWindow(weekEnding) {
        const index = weeks.findIndex((week) => week.weekEnding === weekEnding);
        if (index === -1) {
          return [];
        }
        const start = Math.max(0, index - windowRadius);
        const end = Math.min(weeks.length, index + windowRadius + 1);
        return weeks.slice(start, end);
      }

      function toShiftSeries(windowWeeks, field) {
        return windowWeeks.map((week) => {
          const value = week[field];
          return typeof value === "number" && Number.isFinite(value) ? value : null;
        });
      }

      function toFillSeries(windowWeeks, field) {
        return windowWeeks.map((week) => {
          const value = week[field];
          return typeof value === "number" && Number.isFinite(value) ? value * 100 : null;
        });
      }

      function createLineChart(context, datasets, options) {
        return new Chart(context, {
          type: "line",
          data: {
            labels: [],
            datasets,
          },
          options,
        });
      }

      const sharedOptions = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false,
        },
        plugins: {
          legend: {
            position: "bottom",
            labels: { usePointStyle: true },
          },
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 0,
            },
          },
          y: {
            beginAtZero: true,
          },
        },
      };

      const shiftChart = createLineChart(
        shiftCtx,
        [
          {
            label: "2024 Shift Count",
            data: [],
            borderColor: "#60a5fa",
            backgroundColor: "#bfdbfe",
            tension: 0.3,
            spanGaps: true,
          },
          {
            label: "2025 Shift Count",
            data: [],
            borderColor: "#2563eb",
            backgroundColor: "#93c5fd",
            tension: 0.3,
            spanGaps: true,
          },
        ],
        {
          ...sharedOptions,
          scales: {
            ...sharedOptions.scales,
            y: {
              ...sharedOptions.scales.y,
              ticks: {
                precision: 0,
              },
            },
          },
        }
      );

      const fillChart = createLineChart(
        fillCtx,
        [
          {
            label: "2024 Fill Rate",
            data: [],
            borderColor: "#34d399",
            backgroundColor: "#a7f3d0",
            tension: 0.3,
            spanGaps: true,
          },
          {
            label: "2025 Fill Rate",
            data: [],
            borderColor: "#0d9488",
            backgroundColor: "#5eead4",
            tension: 0.3,
            spanGaps: true,
          },
        ],
        {
          ...sharedOptions,
          plugins: {
            ...sharedOptions.plugins,
            tooltip: {
              callbacks: {
                label(context) {
                  if (context.parsed.y == null) {
                    return `${context.dataset.label}: N/A`;
                  }
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                },
              },
            },
          },
          scales: {
            ...sharedOptions.scales,
            y: {
              beginAtZero: true,
              suggestedMax: 100,
              ticks: {
                callback(value) {
                  return `${value}%`;
                },
              },
            },
          },
        }
      );

      function updateCharts(weekEnding) {
        const windowWeeks = getWindow(weekEnding);
        const labels = windowWeeks.map((week) => week.label);

        shiftChart.data.labels = labels;
        shiftChart.data.datasets[0].data = toShiftSeries(windowWeeks, "shiftCount2024");
        shiftChart.data.datasets[1].data = toShiftSeries(windowWeeks, "shiftCount2025");
        shiftChart.update();

        fillChart.data.labels = labels;
        fillChart.data.datasets[0].data = toFillSeries(windowWeeks, "fillRate2024");
        fillChart.data.datasets[1].data = toFillSeries(windowWeeks, "fillRate2025");
        fillChart.update();
      }

      const initialWeek = chartData.selectedWeek || weeks[weeks.length - 1].weekEnding;
      if (selectEl.value !== initialWeek) {
        selectEl.value = initialWeek;
      }
      updateCharts(initialWeek);

      selectEl.addEventListener("change", (event) => {
        updateCharts(event.target.value);
      });
    })();
  </script>
{% endif %}
{% endblock %}
